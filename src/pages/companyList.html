<div id="company-list">
  <div class="header">企業一覧　画面</div>
  <div>
    <div style="padding-top: 1%">
      <button onClick="changeScreen('company-entry')">企業追加</button>
      <button onClick="changeScreen('schedule-list')">全ての予定</button>
      志望度
      <select id="company-desire" onchange="sortByDesire()">
        <option value="">-</option>
        <option value="high">高</option>
        <option value="middle">中</option>
        <option value="low">低</option>
      </select>
    </div>
    <ul style="padding: 1%" id="companys-list"></ul>
  </div>
</div>
<script>
  const companyList = document.getElementById("companys-list");
  // 会社一覧の初期画面
  function reloadCompanyList() {
    google.script.run
      .withSuccessHandler((data) => {
        showCompany(data, companyList);
      })
      .getCompanysInfo();
  }
  reloadCompanyList();

  // 志望度を変更した時の処理
  function sortByDesire() {
    const companyDesire = document.getElementById("company-desire").value;
    while (companyList.lastChild) {
      companyList.removeChild(companyList.lastChild);
    }
    google.script.run
      .withSuccessHandler((data) => {
        showCompany(data, companyList);
      })
      .getCompanysByDesire(companyDesire);
  }

  //スケジュール・削除・編集ボタンの作成
  function createBtn(companyList, btnName, inner, className, btnFunction) {
    const btn = document.createElement("button");
    btn.setAttribute("class", className);
    btn.innerHTML = inner;
    btn.setAttribute("onclick", btnFunction);
    companyList.appendChild(btn);
  }

  // スケジュールボタンを押すと、各企業のカレンダーIDをセッションストレージにセットする
  function clickScheduleBtn(id) {
    sessionStorage.setItem("id", id);
    schedulelist();
    changeScreen("schedule-list");
  }

  //編集ボタンを押すと、企業の名前・志望度を変更できるようにする
  function fixCalendarBtn(id) {
    sessionStorage.setItem("id", id);
    const companyEntryHeader = document.getElementById("campany-entry-header");
    companyEntryHeader.innerText = "企業情報の編集";

    // 企業登録画面から更新画面への切り替え
    const companyEntryBtn = document.getElementById("company-entry-btn");
    companyEntryBtn.setAttribute("class", "no-display");
    const companyFixBtn = document.getElementById("company-fix-btn");
    companyFixBtn.setAttribute("class", "");
    changeScreen("company-entry");
  }

  //削除ボタンを押した時の処理
  function deleteCalendarBtn(id) {
    const result = window.confirm("本当に削除してもよろしいですか？");
    if (result == true) {
      google.script.run
        .withSuccessHandler(() => {
          alert("削除しました");
          const companyList = document.getElementById("companys-list");
          companyList.innerHTML = null;
          reloadCompanyList();
        })
        .deleteCalendar(id);
    } else {
      alert("中断しました");
    }
  }

  // 企業名＋各ボタンを表示する
  function showCompany(data, companyList) {
    for (let i = 0; i < data.length; i++) {
      const companys = document.createElement("li");
      companyList.appendChild(companys);
      const company = document.createElement("a");
      company.innerText = data[i].name;
      const companyName = company.innerText;
      companys.appendChild(company);
      const calendarId = data[i].id;

      createBtn(
        company,
        "scheduleBtn",
        "スケジュール",
        "schedule-btn",
        `clickScheduleBtn("${calendarId}")`
      );
      createBtn(
        company,
        "fixBtn",
        "編集",
        "fix-btn",
        `fixCalendarBtn("${calendarId}")`
      );
      createBtn(
        company,
        "deleteBtn",
        "削除",
        "delete-btn",
        `deleteCalendarBtn("${calendarId}")`
      );
    }
  }
</script>
